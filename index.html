<!DOCTYPE html>
<html>
<head>
  <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
  <title>Click Map to Send Coordinates</title>
  <meta charset="utf-8">
  <!-- <link rel="stylesheet" href="/style.css"> -->
  <style>
    #map { height: 90vh; width: 100%; }
    #result { padding: 10px; font-family: Arial; }
    .error { color: red; }
    .success { color: green; }

    /* Zig-zag chat styles */
    .chat-row {
      display: flex;
      align-items: flex-end;
      margin-bottom: 12px;
    }
    .user-row {
      flex-direction: row-reverse;
      justify-content: flex-end;
      width: 100%;
    }
    /* Ensure user avatar is 2cm away from bubble */
    .user-row.chat-avatar {
      margin-left: 100px;
    }
    .bot-row {
      flex-direction: row;
      justify-content: flex-start;
      width: 100%;
    }
    .chat-avatar {
      width: 38px;
      height: 38px;
      border-radius: 50%;
      margin: 0 10px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    }
    .chat-bubble {
      max-width: 60%;
      padding: 12px 18px;
      border-radius: 18px;
      font-size: 15px;
      position: relative;
      box-shadow: 0 2px 8px rgba(0,0,0,0.06);
      margin-bottom: 2px;
      word-break: break-word;
      display: inline-block;
    }
    .user-bubble {
      background: #7ed6df;
      color: #222;
      border-bottom-right-radius: 4px;
      align-self: flex-end;
      margin-left: auto;
      text-align: right;
    }
    .bot-bubble {
      background: #dff9fb;
      color: #222;
      border-bottom-left-radius: 4px;
      align-self: flex-start;
      margin-right: auto;
      text-align: left;
    }
    .chat-time {
      font-size: 12px;
      color: #aaa;
      margin: 0 8px;
      align-self: flex-end;
    }
    /* Golden and bold stars for scores */
    .stars {
      color: #FFD700;
      font-weight: bold;
      font-size: 20px;
      letter-spacing: 2px;
      vertical-align: middle;
    }
  </style>
</head>
<body>
  <div class="map-container">
    <div id="map"></div>
    <div id="result">Click on the map to send coordinates to Python.</div>
  </div>
  <!--chat container starts-->

<div class="chat-container" id="chatContainer" style="width: 350px; height: 100vh; background: white; border-left: 1px solid #e5e7eb; display: flex; flex-direction: column; box-shadow: -2px 0 10px rgba(0, 0, 0, 0.1); position: fixed; right: 0; top: 0; z-index: 1000; transition: transform 0.3s ease;">
    <div class="chat-header" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px; text-align: center; box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1); position: relative;">
      <h2 style="font-size: 18px; font-weight: 600; margin: 0;">üí¨ Chat Assistant</h2>
      <button id="minimizeBtn" style="position: absolute; top: 15px; right: 15px; background: rgba(255, 255, 255, 0.2); border: none; color: white; width: 30px; height: 30px; border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 18px; font-weight: bold; transition: all 0.3s ease;">√ó</button>
    </div>
    
    <div class="chat-messages" id="chatMessages" style="flex: 1; padding: 20px; overflow-y: auto; background: #fafafa; display: flex; flex-direction: column; gap: 12px;">
      <div style="text-align: center; color: #6b7280; font-size: 13px; padding: 16px; background: white; border-radius: 12px; border: 1px dashed #d1d5db;">üëã Type "Hi" to start chatting</div>
    </div>
    
    <div class="chat-input-container" style="padding: 20px; background: white; border-top: 1px solid #e5e7eb; display: flex; gap: 10px; align-items: center;">
      <input type="text" id="chatInput" class="chat-input" placeholder="Type message..." style="flex: 1; padding: 12px 16px; border: 2px solid #e5e7eb; border-radius: 25px; font-size: 14px; outline: none; transition: all 0.3s ease; background: #f9fafb;">
      <button id="sendButton" class="send-button" style="padding: 12px 20px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border: none; border-radius: 25px; color: white; cursor: pointer; font-size: 14px; font-weight: 600; transition: all 0.3s ease; min-width: 70px;">Send</button>
    </div>
</div>

<!-- Floating Chat Button (appears when minimized) -->
<button id="chatToggleBtn" style="display: none; position: fixed; bottom: 30px; right: 30px; width: 60px; height: 60px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border: none; border-radius: 50%; color: white; cursor: pointer; font-size: 24px; box-shadow: 0 4px 20px rgba(102, 126, 234, 0.4); z-index: 1001; transition: all 0.3s ease;">üí¨</button>

  <!--chat container ends-->

  <script>

    const API_KEY = "{{ google_maps_api_key }}";
    const FLASK_URL = "{{ flask_url }}";

    
function initMap() {
  google.charts.load('current', {'packages':['corechart']}); // load Google Charts once

  const map = new google.maps.Map(document.getElementById("map"), {
    zoom: 5,
    center: { lat: 12.5, lng: 80.0 },
  });

  // ==============================
  // Legend for marker colors (Bottom-Left)
  // ==============================
  const legendDiv = document.createElement('div');
  legendDiv.style.background = 'white';
  legendDiv.style.padding = '10px';
  legendDiv.style.margin = '10px';
  legendDiv.style.border = '1px solid #ccc';
  legendDiv.style.borderRadius = '5px';
  legendDiv.style.fontFamily = 'Arial, sans-serif';
  legendDiv.innerHTML = `
    <b>Buoy Status Legend</b><br>
    <span style="color:green;">‚óè Active</span><br>
    <span style="color:orange;">‚óè Active (OMNI)</span><br>
    <span style="color:red;">‚óè Inactive (OMNI)</span>
  `;
  map.controls[google.maps.ControlPosition.BOTTOM_LEFT].push(legendDiv);

  // ==============================
  // 1. Define buoy dataset
  // ==============================
  const buoys = [
    { id: "AD06", lat: 18.283661, lng: 67.221405, status: "Active (OMNI)" },
    { id: "AD08", lat: 12.159192, lng: 67.933792, status: "Active (OMNI)" },
    { id: "CB02", lat: 10.87912,  lng: 72.21461, status: "Active" },
    { id: "CALVAL", lat: 10.49902, lng: 72.20533, status: "Active" },
    { id: "AD10", lat: 10.322393, lng: 72.597847, status: "Inactive (OMNI)" },
    { id: "BD11", lat: 13.468, lng: 84.115, status: "Inactive (OMNI)" },
    { id: "BD13", lat: 13.998627, lng: 87.032043, status: "Active (OMNI)" },
    { id: "BD10", lat: 16.328911, lng: 88.00573, status: "Active (OMNI)" },
    { id: "BD14", lat: 6.583954, lng: 88.398712, status: "Active (OMNI)" },
    { id: "CB01", lat: 11.589352, lng: 92.595444, status: "Active" },
    { id: "BD12", lat: 10.550171, lng: 94.044556, status: "Active (OMNI)" }
  ];

  // Dummy data
  const dummyData = {
    salinity: [35, 36, 34, 35, 36, 37],
    temperature: [28, 29, 27, 28, 30, 31],
    humidity: [70, 72, 68, 71, 69, 73],
    waveHeight: [1.2, 1.5, 1.1, 1.3, 1.6, 1.4],
    windSpeed: [5, 6, 5.5, 6.2, 5.8, 6.0],
    currentSpeed: [0.5, 0.6, 0.4, 0.7, 0.6, 0.5]
  };

  // ==============================
  // 2. Add buoy markers with charts
  // ==============================
  buoys.forEach(buoy => {
    // Color-coded markers
    let iconColor = "red";
    if(buoy.status === "Active") iconColor = "green";
    else if(buoy.status === "Active (OMNI)") iconColor = "orange";

    const marker = new google.maps.Marker({
      position: { lat: buoy.lat, lng: buoy.lng },
      map: map,
      title: buoy.id,
      icon: {
        url: `http://maps.google.com/mapfiles/ms/icons/${iconColor}-dot.png`,
        scaledSize: new google.maps.Size(20, 20)
      }
    });

    const infoContent = `
      <div style="width: 300px; font-family: Arial, sans-serif;">
        <h3>Buoy ID: ${buoy.id}</h3>
        <p><b>Status:</b> ${buoy.status}</p>
        <p><b>Lat:</b> ${buoy.lat}<br><b>Lng:</b> ${buoy.lng}</p>
        <label for="paramSelect-${buoy.id}">Parameter:</label>
        <select id="paramSelect-${buoy.id}" style="margin-bottom:10px;">
          <option value="salinity">Salinity</option>
          <option value="temperature">Temperature</option>
          <option value="humidity">Humidity</option>
          <option value="waveHeight">Wave Height</option>
          <option value="windSpeed">Wind Speed</option>
          <option value="currentSpeed">Current Speed</option>
        </select>
        <div id="chart-${buoy.id}" style="width: 100%; height: 220px;"></div>
        <div id="summary-${buoy.id}" style="margin-top:5px; font-size:13px; color:#555;"></div>
      </div>
    `;

    const infoWindow = new google.maps.InfoWindow({ content: infoContent });

    marker.addListener("click", () => {
      infoWindow.open(map, marker);
      setTimeout(() => {
        drawChart(buoy.id, 'salinity');
        const dropdown = document.getElementById(`paramSelect-${buoy.id}`);
        dropdown.addEventListener('change', (e) => drawChart(buoy.id, e.target.value));
      }, 200);
    });
  });

  // ==============================
  // 3. Click-to-send-coordinates
  // ==============================
  map.addListener("click", async function (e) {
    const lat = e.latLng.lat();
    const lng = e.latLng.lng();
    const resultDiv = document.getElementById("result");
    resultDiv.innerHTML = `Sending coordinates: ${lat.toFixed(6)}, ${lng.toFixed(6)}...`;

    try {
      const response = await fetch("http://localhost:5000/process-coordinates", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ lat, lng }),
      });
      if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
      const data = await response.json();
      resultDiv.innerHTML = `<span class="success">${data.message}</span>`;
    } catch (error) {
      console.error('Error:', error);
      resultDiv.innerHTML = `<span class="error">Error: ${error.message}</span>`;
    }
  });

  // ==============================
  // 4. Enhanced chart drawing with axes & values
function drawChart(buoyId, parameter) {
  google.charts.setOnLoadCallback(() => {
    const values = dummyData[parameter];
    const dataArray = [['Time', parameter]];
    values.forEach((val, idx) => dataArray.push([`T${idx+1}`, val]));
    const data = google.visualization.arrayToDataTable(dataArray);

    const min = Math.floor(Math.min(...values) - 1);
    const max = Math.ceil(Math.max(...values) + 1);

    const options = {
      title: parameter.charAt(0).toUpperCase() + parameter.slice(1) + ' over time',
      legend: { position: 'bottom' },
      curveType: 'function',
      pointSize: 5,
      hAxis: {
        title: 'Time Step',
        titleTextStyle: { fontSize: 14 },
        textStyle: { fontSize: 12 },
        textPosition: 'out', // ensures labels show
        gridlines: { count: values.length }
      },
      vAxis: {
        title: parameterUnit(parameter),
        titleTextStyle: { fontSize: 14 },
        textStyle: { fontSize: 12 },
        textPosition: 'out', // ensures numbers show
        viewWindow: { min: min, max: max },
        gridlines: { count: 6 }
      },
      colors: [parameterColor(parameter)],
      height: 220,
      chartArea: { width: '90%', height: '70%' }
    };

    const chartDiv = document.getElementById(`chart-${buoyId}`);
    if (chartDiv) {
      const chart = new google.visualization.LineChart(chartDiv);
      chart.draw(data, options);

      // Display min/max/avg
      const avg = (values.reduce((a,b)=>a+b,0)/values.length).toFixed(2);
      const summaryDiv = document.getElementById(`summary-${buoyId}`);
      if(summaryDiv) summaryDiv.innerHTML = `<b>Min:</b> ${Math.min(...values)} ${parameterUnit(parameter)} | <b>Max:</b> ${Math.max(...values)} ${parameterUnit(parameter)} | <b>Avg:</b> ${avg} ${parameterUnit(parameter)}`;
    }
  });
}



  function parameterUnit(param) {
    switch(param){
      case 'temperature': return '¬∞C';
      case 'salinity': return 'PSU';
      case 'humidity': return '%';
      case 'waveHeight': return 'm';
      case 'windSpeed': return 'm/s';
      case 'currentSpeed': return 'm/s';
      default: return '';
    }
  }

  function parameterColor(param){
    switch(param){
      case 'temperature': return '#FF5722';
      case 'salinity': return '#2196F3';
      case 'humidity': return '#4CAF50';
      case 'waveHeight': return '#03A9F4';
      case 'windSpeed': return '#FFC107';
      case 'currentSpeed': return '#9C27B0';
      default: return '#000';
    }
  }
}





    function addMessage(message, isUser = false) {
      const chatMessages = document.getElementById('chatMessages');
      const msgWrapper = document.createElement('div');
      msgWrapper.className = isUser ? 'chat-row user-row' : 'chat-row bot-row';

      // Avatar
      const avatar = document.createElement('img');
      avatar.className = 'chat-avatar';
      avatar.src = isUser
        ? 'https://cdn-icons-png.flaticon.com/512/4140/4140048.png' // user avatar
        : 'https://cdn-icons-png.flaticon.com/512/4712/4712027.png'; // bot avatar (robot)
      avatar.alt = isUser ? 'You' : 'Bot';

      // Message bubble
      const bubble = document.createElement('div');
      bubble.className = isUser ? 'chat-bubble user-bubble' : 'chat-bubble bot-bubble';
      bubble.textContent = message;

      // Timestamp
      const time = document.createElement('div');
      time.className = 'chat-time';
      const now = new Date();
      time.textContent = now.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });

      // Layout zig-zag
      if (isUser) {
        msgWrapper.appendChild(bubble);
        msgWrapper.appendChild(avatar);
        msgWrapper.appendChild(time);
      } else {
        // Bot: avatar then bubble then time
        msgWrapper.appendChild(avatar);
        msgWrapper.appendChild(bubble);
        msgWrapper.appendChild(time);
      }

      chatMessages.appendChild(msgWrapper);
      chatMessages.scrollTop = chatMessages.scrollHeight;
    }

    async function sendMessage() {
      const input = document.getElementById('chatInput');
      const message = input.value.trim();
      if (!message){
        return message
      };

      addMessage(message, true);
      input.value = '';

    async function sendChat(message, station=null) {
      try {
        const resp = await fetch('/chat', {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({ message, station })
        });
        const data = await resp.json();
        if (data && data.response) {
          addMessage(data.response, false); // bot reply
        } else if (data.error) {
          addMessage("Error: " + data.error, false);
        }
      } catch (err) {
        addMessage("Network error: " + err.message, false);
      }
    }
      
    // Show typing indicator
    const typingDiv = document.createElement('div');
    typingDiv.id = 'typing-indicator';
    typingDiv.style.cssText = "margin-bottom: 12px; text-align: left;";
    typingDiv.innerHTML = `<div style="display: inline-block; max-width: 80%; padding: 12px 16px; border-radius: 18px; font-size: 14px; background: white; color: #666; border: 1px solid #e5e7eb; border-bottom-left-radius: 6px;">Thinking for a better answer....</div>`;
    document.getElementById('chatMessages').appendChild(typingDiv);
    document.getElementById('chatMessages').scrollTop = document.getElementById('chatMessages').scrollHeight;

    try {
        // Send message to Flask
        const response = await fetch("http://localhost:5000/chat", {
        method: "POST",
        headers: {
            "Content-Type": "application/json",
        },
        body: JSON.stringify({ message: message }),
        });

        const data = await response.json();
        
        // Remove typing indicator
        const typingIndicator = document.getElementById('typing-indicator');
        if (typingIndicator) {
        typingIndicator.remove();
        }

        // Add bot response
        if (data.response) {
        addMessage(data.response, false);
        } else if (data.error) {
        addMessage(`Error: ${data.error}`, false);
        } else {
        addMessage("Sorry, I didn't understand that.", false);
        }

    } catch (error) {
        // Remove typing indicator
        const typingIndicator = document.getElementById('typing-indicator');
        if (typingIndicator) {
        typingIndicator.remove();
        }
        
        console.error('Chat error:', error);
        addMessage("Sorry, I'm having trouble connecting. Please try again.", false);
    }
    }

    document.getElementById('sendButton').addEventListener('click', sendMessage);
    document.getElementById('chatInput').addEventListener('keypress', function(e) {
      if (e.key === 'Enter') sendMessage();
    });
  </script>

  <script async defer
    src="https://maps.googleapis.com/maps/api/js?key={{ google_maps_api_key }}&callback=initMap">
  </script>
</body>
</html>